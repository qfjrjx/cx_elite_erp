<style>
    #purchaseMaterialFile-update {
        padding: 20px 25px 25px 0;
    }
</style>
<div class="layui-fluid" id="purchaseMaterialFile-update">
    <form class="layui-form" action="" lay-filter="purchaseMaterialFile-update-form">
        <div class="layui-form-item febs-hide">
            <label class="layui-form-label febs-form-item-require">参数id：</label>
            <div class="layui-input-block">
                <input type="text" name="id" data-th-value="${purchaseMaterialFile.id}">
            </div>
        </div>
        <div class="layui-col-md9">
            <div class="layui-form-item">
                <label class="layui-form-label" >编&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;号：</label>
                <div class="layui-input-inline" style="width: 170px">
                    <input type="text" name="materialCode" id="materialCode" style="width: 170px" readonly
                           autocomplete="off" class="layui-input" placeholder="为空时自动生成" >
                </div>
                <label class="layui-form-label " >物料名称：</label>
                <div class="layui-input-inline" style="width: 170px">
                    <input type="text" name="materialName" id="materialName" style="width: 170px" lay-verify="required"
                           autocomplete="off" class="layui-input" placeholder="请输入名称" >
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label " >规格型号：</label>
                <div class="layui-input-block" style="width: 460px">
                    <input type="text" name="specificationsModel" style="width: 460px"
                           autocomplete="off" class="layui-input" placeholder="">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label " >库&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;位：</label>
                <div class="layui-input-block" style="width: 460px">
                    <input type="text" name="materialLocation" style="width: 460px"
                           autocomplete="off" class="layui-input" placeholder="">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label " >材&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;质：</label>
                <div class="layui-input-inline" style="width: 170px" id="content4">
                    <select id="materialQualityId" style="width: 170px"  name="materialQualityId" type="select" class="layui-form-select selector" lay-filter="materialQualityId">
                        <option value="" ></option>
                        <option th:each="productMaterial:${productMaterial}" th:value="${productMaterial.id}">[[${productMaterial.purchaseParametersName}]]</option>
                    </select>
                </div>
                <label class="layui-form-label " >品&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;牌：</label>
                <div class="layui-input-inline" style="width: 170px">
                    <input type="text" name="materialBrand" id="materialBrand" style="width: 170px"
                           autocomplete="off" class="layui-input" placeholder="" >
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label " >大&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;类：</label>
                <div class="layui-input-inline" style="width: 170px" id="content1">
                    <select id="generalCategoryId" style="width: 170px"  name="generalCategoryId" type="select" lay-verify="required"  class="layui-form-select selector" lay-filter="generalCategoryId">
                        <option value="" ></option>
                        <option th:each="generalCategory:${generalCategory}" th:value="${generalCategory.id}">[[${generalCategory.categoryName}]]</option>
                    </select>
                </div>
                <label class="layui-form-label " >小&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;类：</label>
                <div class="layui-input-inline" style="width: 170px">
                    <select id="materialSubclassId" style="width: 170px"  name="materialSubclassId" type="select" lay-verify="required"  class="layui-form-select selector" lay-filter="materialSubclassId">
                        <option th:each="purchaseMaterialCategory:${purchaseMaterialCategory}" th:value="${purchaseMaterialCategory.id}">[[${purchaseMaterialCategory.categoryName}]]</option>

                    </select>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label " >计量单位：</label>
                <div class="layui-input-inline" style="width: 170px" id="content3">
                    <select id="meteringCompanyId" style="width: 170px"  name="meteringCompanyId" type="select" lay-verify="required"  class="layui-form-select selector" lay-filter="meteringCompanyId">
                        <option value="" ></option>
                        <option th:each="unitOfMeasure:${unitOfMeasure}" th:value="${unitOfMeasure.id}">[[${unitOfMeasure.purchaseParametersName}]]</option>
                    </select>
                </div>
                <label class="layui-form-label " >理论重量：</label>
                <div class="layui-input-inline" style="width: 170px">
                    <input type="text" name="theoreticalWeight" id="theoreticalWeight" style="width: 170px"
                           autocomplete="off" class="layui-input" placeholder="" >
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label " >库存上限：</label>
                <div class="layui-input-inline" style="width: 170px">
                    <input type="text" name="inventoryCeiling" id="inventoryCeiling" style="width: 170px"
                           autocomplete="off" class="layui-input" placeholder="" >
                </div>
                <label class="layui-form-label " >库存下限：</label>
                <div class="layui-input-inline" style="width: 170px">
                    <input type="text" name="inventoryLower" id="inventoryLower" style="width: 170px"
                           autocomplete="off" class="layui-input" placeholder="" >
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label " >最小单位：</label>
                <div class="layui-input-inline" style="width: 170px">
                    <input type="text" name="minimumUnit" id="minimumUnit" style="width: 170px"
                           autocomplete="off" class="layui-input" placeholder="" value="1">
                </div>
                <label class="layui-form-label">状&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;态：</label>
                <div class="layui-input-inline" style="width: 170px">
                    <select name="materialState" style="width: 170px">
                        <option value="1">启用</option>
                        <option value="2">禁用</option>
                    </select>
                </div>
            </div>
      </div>
        <div class="layui-col-md3 layui-col-sm12 layui-col-xs12 table-action-area">
                <div class="layui-upload">
                    　<!-- 隐藏的input,一个隐藏的input（用于保存文件url） -->
                    <div class="layui-upload-list" id="uploadPic1"
                         style="margin-top: 15%;width: 180px;height: 300px; border: 1px solid #c2c2c2;margin-left: 5%;">
                        <img class="layui-upload-img" th:src="@{'/file/uploadFile/'+${purchaseMaterialFile.materialPicture}}" onclick="showImg(this)"  id="preShow" name="preShow" width="180px" height="300px" >
                        <p id="demoText"></p>
                    </div>
                </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">备&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;注：</label>
            <div class="layui-input-block">
                <textarea name="materialRemarks" maxlength="100" class="layui-textarea" placeholder=""></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            　　<label class="layui-form-label">图&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;片：</label>
            　　<div class="layui-input-inline" style="width: 600px">
                    <button type="button" class="layui-btn layui-btn-sm" id="uploadPic"><i class="layui-icon">&#xe67c;</i>选择文件</button>
                    <button type="button" class="layui-btn layui-btn-sm layui-btn-warm" id="uploadPicBtn"><i class="layui-icon layui-icon-upload-circle"></i>开始上传</button>
                    <span id="span-img" style="color: #f5222d"></span>
                    <button type="button" class="layui-btn layui-btn-sm layui-btn-danger" id="deletePicBtn"><i class="layui-icon layui-icon-close"></i>删除</button>
                    <!-- 隐藏的input,一个隐藏的input（用于保存文件url） -->
                    　　　　 <input type="hidden" id="img_url" name="materialPicture" value=""/>    　　
                </div>
        </div>
        <div class="layui-form-item febs-hide">
            <button class="layui-btn" lay-submit="" lay-filter="purchaseMaterialFile-update-form-submit" id="submit"></button>
            <button type="reset" class="layui-btn" id="reset"></button>
        </div>
    </form>
</div>

<script data-th-inline="javascript">
    layui.use(['febs', 'form', 'validate', 'xmSelect','laydate','upload'], function () {
        let $ = layui.$,
            febs = layui.febs,
            laydate = layui.laydate,
            layer = layui.layer,
            form = layui.form,
            purchaseMaterialFile = [[${purchaseMaterialFile}]],
            validate = layui.validate,
            upload = layui.upload,
            uploadInst;

        form.verify(validate);
        form.render();

        //二级联动
        form.on("select(generalCategoryId)",function (data) {
            var division1id = data.value;
            $.ajax({
                type : "post",
                url : "purchaseMaterialFile/query",
                data : {'id':division1id},
                dataType : "json",
                success : function(d) {
                    var tmp = '';
                    for ( var i in d) {
                        tmp += '<option value="' + d[i].id +  '">' + d[i].categoryName + '</option>';
                    }
                    $("#materialSubclassId").html(tmp);
                    form.render();
                },
                error:function(){
                    layer.alert('请求失败，稍后再试', {icon: 5});
                }
            });
        });

        initPurchaseMaterialFileValue();

        function initPurchaseMaterialFileValue() {
            form.val("purchaseMaterialFile-update-form", {
                "materialCode": purchaseMaterialFile.materialCode,
                "materialName": purchaseMaterialFile.materialName,
                "specificationsModel": purchaseMaterialFile.specificationsModel,
                "materialLocation": purchaseMaterialFile.materialLocation,
                "materialQualityId": purchaseMaterialFile.materialQualityId,
                "materialBrand": purchaseMaterialFile.materialBrand,
                "generalCategoryId": purchaseMaterialFile.generalCategoryId,
                "materialSubclassId": purchaseMaterialFile.materialSubclassId,
                "meteringCompanyId": purchaseMaterialFile.meteringCompanyId,
                "theoreticalWeight": purchaseMaterialFile.theoreticalWeight,
                "inventoryCeiling": purchaseMaterialFile.inventoryCeiling,
                "inventoryLower": purchaseMaterialFile.inventoryLower,
                "minimumUnit": purchaseMaterialFile.minimumUnit,
                "materialState": purchaseMaterialFile.materialState,
                "materialRemarks": purchaseMaterialFile.materialRemarks
            });
        };

        //上传图片
        uploadInst = upload.render({
            elem: '#uploadPic' //绑定元素
            ,url: 'document/uploadPictureImg' //上传接口 [[@{/upload/img}]]
            ,auto: false
            ,size: 307200 //限制文件大小，单位 KB
            ,accept: 'file' //允许上传的文件类型
            ,exts: 'jpg|jpeg|png|'
            ,bindAction: '#uploadPicBtn'
            ,before: function(obj){
                //预读本地文件示例，不支持ie8
                obj.preview(function(index, file, result){
                    $('#preShow').attr('src', result); //图片链接（base64）
                });
            }
            ,done: function(res){
                //如果上传失败
                if(res.code > 0){
                    alert("上传失败");
                    return layer.msg('上传失败');
                }
                //上传成功
                $('#span-img').html(res.data);
                $('#img_url').attr('value', res.dataName);
                return layer.msg('上传成功');
            }
            ,error: function(){
                var demoText = $('#demoText');
                demoText.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-mini demo-reload">重试</a>');
                demoText.find('.demo-reload').on('click', function(){
                    uploadInst.upload();
                });
            }
        });
        $("#deletePicBtn").click(function () {
            var contFile = document.getElementById("span-img").innerText;
            if(contFile == ""){
                return layer.msg('您还没有上传文件！');
            }else {
                $.ajax({
                    url: '/saleDocumentFile/deleteFile',
                    data: {contFile: contFile},
                    success : function(res) {
                        //如果上传失败
                        if(res.code >0){
                            return layer.msg('删除失败');
                        }else {
                            $('#span-img').html("");
                            $('#preShow').attr('src', ''); //图片链接（base64）
                            return layer.msg('删除成功');
                        }
                    }
                });
            }

        });
        form.on('submit(purchaseMaterialFile-update-form-submit)', function (data) {
            febs.post(ctx + 'purchaseMaterialFile/update', data.field, function () {
                layer.closeAll();
                febs.alert.success('修改成功');
                $('#purchaseMaterialFile-list').find('#query').click();
            });
            return false;

        });

    });
    //通过点击，使图片放大（方法）
    function showImg(t) {
        //Layui的弹出层
        layer.open({
            type: 1,
            title: false,
            closeBtn: 0,
            area: '1200px',
            skin: 'layui-layer-nobg', //没有背景色
            shadeClose: true,
            content: '<img style="display: inline-block; width: 100%; height: 100%;" src="'+t.src+'">'
        });
    }
</script>